{"version":3,"sources":["src/const.ts","src/analytics/analytics-api.ts","src/analytics/analytics.ts","src/ab-test/const.ts","src/ab-test/local-storage.ts","src/ab-test/index.ts","src/api/logger.ts","src/index.ts"],"names":[],"mappings":"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","file":"src.c822c728.js","sourceRoot":"..","sourcesContent":["export const CTA_SELECTOR = 'data-cta' // for the button\nexport const userId = '1' // for the test reason id is here as a const\nexport const isRegisteredUser = false // We need only unregistered users","/**\n * Tracks a pageview to our \"imaginary api\" - in this demo just the browser console. ;)\n * Send as params whatever you might seem valuable to send.\n * The URL is probably a good start though.\n */\n\ntype Payload = {\n  userId: string,\n  ts: number,\n  url: string,\n}\n\ntype PageViewPayload  = Payload & {\n    type: 'load' | 'unload'\n}\n\ntype EventPayload = Payload & {\n    type: 'click'\n}\n\n// send page events like open, close, scroll\nexport const trackPageview = (payload: PageViewPayload): void => {\n    const parsed: String = JSON.stringify(payload)\n    console.log(`--> Tracking Pageview: ${parsed}`);\n};\n\n// sent user events like press, click\nexport const trackEvent = (payload: EventPayload): void => {\n    const parsed: String = JSON.stringify(payload)\n    console.log(`--> Tracking Event: ${parsed}`);\n};\n","import {trackPageview, trackEvent} from \"./analytics-api\";\n\nexport const initAnalytics = (userId: string, url: string, ctaSelector: string): void => {\n  const loadPage = () => trackPageview({ts: Date.now(), url, type: 'load', userId})\n  const clickCta = () => trackEvent({ts: Date.now(), url, type: 'click', userId})\n  const unloadPage = () => {\n    window.removeEventListener('load', loadPage)\n    window.removeEventListener('click', clickCta)\n    window.removeEventListener('beforeunload', unloadPage)\n\n    trackPageview({ts: Date.now(), url, type: 'unload', userId})\n  }\n\n  window.addEventListener('load', loadPage)\n\n  const ctaButton = document.querySelector(`[${ctaSelector}]`)\n  if (ctaButton) ctaButton.addEventListener('click', clickCta)\n\n  window.addEventListener('beforeunload', unloadPage)\n}","export const AB_SELECTOR = 'data-test' // main selector of the test. Only one per document\nexport const AB_SELECTOR_EXPIRATION = 'data-expiration' // date of test expiration\nexport const AB_SELECTOR_VARIANT = 'data-variant' // test variant letter\n\nexport const AB_IMAGE_SELECTOR = 'data-src' // for image optimization\n\nexport const LS_NAME = 'APP_ABTEST'","import {LS_NAME} from \"./const\";\n\nexport type LStest = {\n    ts: string,\n    url: string,\n    name: string\n    variant: string,\n    expiration: string,\n}\n\nfunction isLStest(item: any): item is LStest {\n    // explicit properties\n    if ((typeof item.ts !== 'string') && (typeof item.url !== 'string')) return false\n    if ((typeof item.name !== 'string') && (typeof item.variant !== 'string')) return false\n    if (typeof item.name !== 'string') return false\n    return true\n}\n\nexport const read = (url: string): LStest | null => {\n  const key = `${LS_NAME}_${url}`\n    const rawItem = localStorage.getItem(key)\n    if (!rawItem) return null\n    let item: unknown\n\n    try {\n        item = JSON.parse(rawItem)\n    } catch {\n        console.log('LS parsing error') // Not real log\n        remove(url)\n        return null\n    }\n\n    if (isLStest(item)) return item\n    return null\n}\n\nexport const write = (params: LStest): void => {\n    localStorage.setItem(`${LS_NAME}_${params.url}`, JSON.stringify(params))\n}\n\nexport const remove = (url: string): void => {\n  const key = `${LS_NAME}_${url}`\n  localStorage.removeItem(key)\n}","import {AB_SELECTOR, AB_SELECTOR_VARIANT, AB_SELECTOR_EXPIRATION, AB_IMAGE_SELECTOR} from \"./const\";\nimport {LStest, read, remove, write} from \"./local-storage\";\n\n// TODO later: optimize media loading with data-src\n\ntype InitParams = {\n    userId: string,\n    isRegisteredUser: boolean,\n    url: string\n}\n\nconst validateExpirationDate = (expirationDate: string): boolean => {\n    const date = new Date(expirationDate)\n\n    if (date.toString() === 'Invalid date') return false\n    if (date.getTime() <= Date.now()) return false\n\n    return true\n}\n\nconst hideOtherVariants = (variants: Element[]) => (name?: string): void => {\n    let variantIndex = 0;\n    if (name) {\n        variantIndex = variants.findIndex(node => node.getAttribute(AB_SELECTOR_VARIANT) === name);\n    }\n    if (variantIndex < 0) variantIndex = 0; // show default\n    [...variants.slice(0, variantIndex), ...variants.slice(variantIndex + 1)].forEach(node => node.remove())\n}\n\nconst hideLoader = () => {\n  const loader = document.querySelector('.loader')\n  loader?.remove()\n}\n\nconst loadimages = () => {\n  const unloadedImages = document.querySelectorAll(`[${AB_IMAGE_SELECTOR}]`)\n  if (unloadedImages.length === 0) return\n\n  unloadedImages.forEach(img => {\n    const src = img.getAttribute(AB_IMAGE_SELECTOR)\n    src && img.setAttribute('src', src)\n  })\n}\n\n\nexport const initABTest = (params: InitParams, log?: (payload: string) => void): void => {\n    const testEl = document.querySelector(`[${AB_SELECTOR}]`)\n    if (!testEl) return // no test, show as is, OK\n\n    const testVariants = testEl.querySelectorAll(`[${AB_SELECTOR_VARIANT}]`)\n    if (testVariants.length < 2) {\n        log?.('AB test, less then 2 variants')\n        remove(params.url)\n        return\n    } // log ERROR, show as is\n\n  const showVariant = (name?: string) => {\n      hideOtherVariants(Array.from(testVariants))(name)\n      loadimages()\n      hideLoader()\n    }\n\n    // Further we have two+ variants\n    const testName = testEl.getAttribute(AB_SELECTOR)\n    if (!testName) {\n        log?.('AB test, no test name')\n        remove(params.url)\n        showVariant()\n        return\n    }\n\n\n    const expirationDate = testEl.getAttribute(AB_SELECTOR_EXPIRATION)\n    if (!expirationDate) {\n        log?.('AB test, no expiration date')\n        remove(params.url)\n        showVariant()\n        return\n    }// log error, select first variant (control)\n    if (!validateExpirationDate(expirationDate)) {\n        log?.('AB test, wrong expiration date')\n        remove(params.url)\n        showVariant()\n        return\n    }\n\n    if (params.isRegisteredUser) {\n        showVariant()\n        return\n    }// select first variant (control)\n\n    // check LS\n    const variantFromLS = (test: LStest): string | void => {\n        const compareTestAndLS = (test: LStest, ls: LStest): boolean => {\n            if (test.name !== ls.name) return false\n            if (test.expiration !== ls.expiration) return false\n            if (test.url !== ls.url) return false\n            return true\n        }\n\n        const lsVariant = read(params.url)\n        if (!lsVariant) return\n        if (!compareTestAndLS(test, lsVariant)) {\n            log?.('AB test, wrong LS data')\n            return\n        }\n\n        return lsVariant.variant\n    }\n\n    const test: LStest = {\n        ts: `${Date.now()}`,\n        variant: 'A',\n        name: testName,\n        url: params.url,\n        expiration: expirationDate\n    }\n    const LStestVariant = variantFromLS(test)\n    if (LStestVariant) {\n        showVariant(LStestVariant)\n        return\n    }\n\n    // randomly assign a variant, show it\n    const numberOfVariants: number = testVariants.length\n    const randomVariant: number = Math.floor(Math.random() * numberOfVariants);\n    const randomName = Array.from(testVariants)[randomVariant].getAttribute(AB_SELECTOR_VARIANT)\n\n    if (!randomName) {\n        log?.('AB test, can not define random variant name')\n        showVariant()\n        return\n    }\n\n    write({\n        ...test,\n        variant: randomName,\n    })\n    showVariant(randomName)\n}\n","type LoggerEvent = {\n  url: string,\n  type: 'error',\n  payload: string\n}\n\n// logs events params: type, url, payload\nexport const log = (payload: LoggerEvent): void => {\n  console.log(`--> Logger: ${JSON.stringify(payload)}`);\n};","import \"./styles.css\";\nimport {CTA_SELECTOR, userId, isRegisteredUser} from \"./const\";\nimport {initAnalytics} from \"./analytics/analytics\";\nimport {initABTest} from \"./ab-test\"\nimport {log} from \"./api/logger\"\n\n// Your code here\n\n// Parse HTML for test info\n// Parse cookies\n// Compare cookies and HTML\n// Apply final variant changes to HTML\n\n\n// TODO\n\n// Add analytics tracker\nconst url: string = window.location.href\nconst logger = (payload: string) => log({url, type: 'error', payload})\n\ninitAnalytics(userId, url, CTA_SELECTOR)\ninitABTest({url, userId, isRegisteredUser}, logger)\n\n\n\n\n// Work with HTML service\n// Work with cookie service\n// Log errors servise"]}